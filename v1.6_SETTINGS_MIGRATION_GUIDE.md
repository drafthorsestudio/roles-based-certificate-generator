# Certificate Generator v1.6 - Settings Migration Guide

## What's New in v1.6

Version 1.6 removes hardcoded configuration and adds a **Settings page** where administrators can configure:
- Role-to-Group mappings
- Which taxonomy to use for filtering
- Enable/disable group-based filtering

## Important: First-Time Setup Required

After upgrading to v1.6, you **must configure settings** before the plugin will work correctly.

### Step 1: Access Settings

1. Go to WordPress Admin
2. Navigate to **Certificate Generator → Settings**
3. You'll see the Settings page with three sections

### Step 2: Configure Taxonomy

**Taxonomy for Filtering:**
- Select which taxonomy to use (typically "group")
- This is the taxonomy that categorizes your trainings
- Default: `group`

### Step 3: Enable Filtering (Optional)

**Enable Group-Based Filtering:**
- ✅ Checked: Users only see trainings from their assigned groups
- ❌ Unchecked: All users see all trainings (no filtering)

**Recommendation:** Keep this enabled if you want role-based access control

### Step 4: Configure Role Mappings

This is where you map PublishPress roles/groups to taxonomy terms.

**What are Role Mappings?**
- **Left Column (User Role/Group):** PublishPress role (e.g., "central_east_editor")
- **Right Column (Maps to Taxonomy Term):** Taxonomy term slug (e.g., "central-east-attc")
- **Meaning:** Users with role "central_east_editor" will only see trainings tagged with "central-east-attc"

**Example Mappings:**

| User Role/Group | → | Maps to Taxonomy Term |
|-----------------|---|-----------------------|
| central_east_editor | → | central-east-attc |
| great_lakes_editor | → | great-lakes-attc |
| mid_america_editor | → | mid-america-attc |

### Step 5: Add Mappings

1. Click **"+ Add Mapping"** to add a row
2. Select a **User Role/Group** from dropdown
3. Select corresponding **Taxonomy Term** from dropdown
4. Repeat for all needed mappings
5. Click **"Save Settings"**

### Step 6: Remove Unwanted Mappings

- Click **"Remove"** button next to any mapping you don't need
- Must keep at least one row (can be blank if not using filtering)

---

## Migrating from v1.5 to v1.6

### Old Hardcoded Mappings (v1.5)

Previously, mappings were hardcoded at line 24:

```php
$role_group_mapping = array(
    'central_east' => 'central-east-attc',
    'central_east_editor' => 'central-east-attc',
    'great_lakes_editor' => 'great-lakes-attc',
    'mid_america_editor' => 'mid-america-attc',
    'new_england_editor' => 'new-england-attc',
    'northeast___caribbean_editor' => 'northeast-caribbean-attc',
    'southeast_editor' => 'southeast-attc',
    'mountain_plains_editor' => 'mountain-plains-attc',
    'northwest_editor' => 'northwest-attc',
    'pacific_southwest_editor' => 'pacific-southwest-attc',
    'south_southwest_editor' => 'south-southwest-attc',
);
```

### New Settings-Based Approach (v1.6)

Now configured via **Certificate Generator → Settings** page.

**To Migrate:**

1. Note your old hardcoded mappings (above)
2. Go to Settings page
3. Add each mapping using the interface
4. Save settings

**Example Migration:**

Old hardcoded:
```
'central_east' => 'central-east-attc'
```

New in Settings UI:
```
[User Role: central_east] → [Taxonomy Term: central-east-attc]
```

---

## Settings Storage

Settings are stored in `wp_options` table:

**Option Name:** `certificate_generator_settings`

**Structure:**
```php
array(
    'role_group_mappings' => array(
        'central_east' => 'central-east-attc',
        'central_east_editor' => 'central-east-attc',
        // ... more mappings
    ),
    'taxonomy_for_filtering' => 'group',
    'enable_network_filtering' => true,
)
```

---

## Troubleshooting

### Users Can't See Any Trainings

**Cause:** No role mappings configured or filtering enabled but no matches

**Solution:**
1. Go to Settings page
2. Verify mappings exist
3. Check that taxonomy term slugs match exactly
4. OR disable "Enable Group-Based Filtering" temporarily

### Wrong Trainings Showing Up

**Cause:** Incorrect role-to-group mapping

**Solution:**
1. Go to Settings
2. Verify each user's role maps to correct taxonomy term
3. Check taxonomy term slugs are exact (case-sensitive)

### Settings Not Saving

**Cause:** Insufficient permissions

**Solution:**
1. Verify user has "manage_options" capability
2. Check for PHP errors in debug log
3. Try deactivating/reactivating plugin

### PublishPress Roles Not Showing

**Cause:** PublishPress not installed or not active

**Solution:**
1. Install/activate PublishPress plugin
2. Refresh settings page
3. Roles should appear in dropdown

**Fallback:** If PublishPress unavailable, WordPress roles will be shown instead

### Taxonomy Not Listed

**Cause:** Taxonomy not registered to 'training' post type

**Solution:**
1. Verify taxonomy is registered correctly
2. Check it's assigned to 'training' post type
3. Re-register taxonomy if needed

---

## Admin Workflow

### Regular Updates

When you need to:
- Add a new regional center
- Add a new user role
- Change which taxonomy to use

**Process:**
1. Go to **Certificate Generator → Settings**
2. Click **"+ Add Mapping"**
3. Select role and term
4. Click **"Save Settings"**
5. Done!

### Bulk Changes

If restructuring your taxonomy:

1. Update taxonomy terms first (in WordPress)
2. Go to Settings page
3. Update all affected mappings
4. Save settings
5. Test with a user from each role

---

## Benefits of Settings Page

### Before (v1.5):
- ❌ Had to edit PHP code
- ❌ Required FTP/file access
- ❌ Risk of syntax errors
- ❌ Lost on plugin updates

### After (v1.6):
- ✅ Easy admin UI
- ✅ No code editing needed
- ✅ Validation prevents errors
- ✅ Settings persist across updates
- ✅ Add/remove mappings anytime
- ✅ Visual feedback

---

## Advanced Configuration

### Disabling Filtering Entirely

Set: **Enable Group-Based Filtering** = Unchecked

**Result:** All users see all trainings (no role-based filtering)

**Use Case:** 
- Single-organization setup
- Everyone should see everything
- Testing/debugging

### Using Different Taxonomy

Change: **Taxonomy for Filtering** = (select different taxonomy)

**Requirements:**
- Taxonomy must be registered to 'training' post type
- Trainings must be tagged with terms from that taxonomy
- Update role mappings to use new taxonomy's terms

**Use Case:**
- Migrating from 'group' to 'category'
- Adding new organizational structure
- Multi-level filtering

---

## Quick Reference

**Access Settings:**
```
WP Admin → Certificate Generator → Settings
```

**Add Mapping:**
```
Click "+ Add Mapping" → Select Role → Select Term → Save
```

**Remove Mapping:**
```
Click "Remove" button → Save Settings
```

**Test Filtering:**
```
1. Save settings
2. Log in as test user with specific role
3. Go to Certificate Generator
4. Verify only correct trainings appear
```

---

## Support

If you encounter issues:

1. **Check error logs:**
   - Look for PHP errors
   - Check WordPress debug.log

2. **Verify PublishPress:**
   - Is it active?
   - Do roles/groups exist?
   - Are users assigned to groups?

3. **Verify Taxonomy:**
   - Does it exist?
   - Is it assigned to 'training'?
   - Do terms exist?
   - Are trainings tagged?

4. **Test with admin account:**
   - Admin can usually bypass filtering
   - Helps isolate permission issues

5. **Temporarily disable filtering:**
   - Uncheck "Enable Group-Based Filtering"
   - See if trainings appear
   - Helps determine if filtering is the issue
